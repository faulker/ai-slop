---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Cargo.toml
  - src/main.rs
  - src/app.rs
  - src/tui.rs
autonomous: true

must_haves:
  truths:
    - "User can run the binary from any git repo subdirectory and the app launches"
    - "User sees two tabs labeled Create Stash and Manage Stashes"
    - "User can press Tab to switch active tab and see the highlight move"
    - "User can press q to quit and terminal is restored to normal state"
    - "If the app panics, terminal raw mode and alternate screen are restored"
  artifacts:
    - path: "Cargo.toml"
      provides: "Project manifest with ratatui, crossterm, git2, color-eyre, strum dependencies"
      contains: "ratatui"
    - path: "src/main.rs"
      provides: "Entry point with panic hooks, terminal init, app run loop, terminal restore"
      min_lines: 20
    - path: "src/app.rs"
      provides: "App struct with SelectedTab enum, event handling, tab rendering"
      min_lines: 60
      exports: ["App", "SelectedTab"]
    - path: "src/tui.rs"
      provides: "Terminal lifecycle helpers: init, restore, install panic hook"
      min_lines: 20
  key_links:
    - from: "src/main.rs"
      to: "src/tui.rs"
      via: "calls tui::init() and tui::restore()"
      pattern: "tui::(init|restore)"
    - from: "src/main.rs"
      to: "src/app.rs"
      via: "creates App and calls app.run()"
      pattern: "App::new|app\\.run"
    - from: "src/app.rs"
      to: "git2::Repository"
      via: "Repository::discover for repo detection"
      pattern: "Repository::discover"
    - from: "src/app.rs"
      to: "ratatui Tabs widget"
      via: "renders tab bar with selected state"
      pattern: "Tabs::new"
    - from: "src/tui.rs"
      to: "std::panic::set_hook"
      via: "installs panic hook that restores terminal"
      pattern: "set_hook|take_hook"
---

<objective>
Set up the complete stash-mgr Rust TUI application with git repo detection, terminal lifecycle management (including panic recovery), and tab-based navigation between Create Stash and Manage Stashes views.

Purpose: Establish the working application skeleton that all subsequent phases build upon. After this plan, a user can cargo run the binary in any git repo, see tabs, switch between them, and quit cleanly.

Output: A runnable Rust TUI binary with tab navigation and git repo detection.
</objective>

<execution_context>
@/Users/sane/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sane/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Project scaffold with terminal lifecycle and git repo detection</name>
  <files>Cargo.toml, src/main.rs, src/tui.rs</files>
  <action>
Initialize the Rust project and set up terminal lifecycle management.

1. Run `cargo init` in the project root to create the Cargo.toml and src/main.rs scaffold.

2. Add dependencies to Cargo.toml:
   - ratatui = "0.29" (TUI framework)
   - crossterm = "0.29" (terminal backend — pin to match ratatui's expected version)
   - git2 = "0.20" (git operations)
   - color-eyre = "0.6" (error reporting)
   - strum = { version = "0.26", features = ["derive"] } (enum helpers for tabs)

3. Create src/tui.rs with terminal lifecycle helpers:
   - `pub fn init() -> color_eyre::Result<Terminal<CrosstermBackend<Stdout>>>` — enables raw mode, enters alternate screen, creates Terminal with CrosstermBackend
   - `pub fn restore() -> color_eyre::Result<()>` — disables raw mode, leaves alternate screen
   - `pub fn install_panic_hook()` — uses `std::panic::take_hook` and `std::panic::set_hook` to wrap the original panic hook with terminal restoration. The custom hook calls `restore()` BEFORE the original hook so terminal is usable when the panic message prints. Also install color_eyre panic hook via `color_eyre::install()`.
   - CRITICAL: `install_panic_hook()` must be called BEFORE `init()` in main.rs. The panic hook captures the restore logic so that ANY panic (including during init) gets caught.

4. Create src/main.rs entry point:
   - Call `tui::install_panic_hook()` first
   - Call `git2::Repository::discover(".")` to verify we are in a git repo. If not, print a user-friendly error ("Error: not a git repository (or any parent up to mount point)") and exit with code 1 — do NOT enter TUI mode for this error.
   - Call `tui::init()` to set up terminal
   - Create `App::new(repo)` passing the discovered Repository
   - Call `app.run(&mut terminal)` for the main event loop
   - Call `tui::restore()` after run completes
   - Return Ok(()) or propagate errors via color_eyre

Do NOT use `ratatui::init()` convenience function — it has less control over panic hooks. Use the explicit crossterm setup in tui.rs for full control.
  </action>
  <verify>
Run `cargo build` — project compiles without errors. Run `cargo run` from within a git repository — app should enter alternate screen (blank for now, will be populated by Task 2). Run `cargo run` from a non-git directory (e.g., /tmp) — should print error message and exit without entering TUI.
  </verify>
  <done>
Project compiles. Binary enters alternate screen in a git repo. Binary prints helpful error outside a git repo. Panic hook is installed so forced panics restore terminal state.
  </done>
</task>

<task type="auto">
  <name>Task 2: Application state, event loop, and tab navigation UI</name>
  <files>src/app.rs, src/main.rs</files>
  <action>
Implement the App struct with TEA pattern, event loop, and tab rendering.

1. Create src/app.rs with:

   a. `SelectedTab` enum with two variants: `Create` and `Manage`. Derive `Default, Clone, Copy, PartialEq` and strum's `Display, FromRepr, EnumIter`. Use `#[default]` on `Create`. Use strum `to_string` attributes: "Create Stash" for Create, "Manage Stashes" for Manage. Add methods:
      - `fn next(self) -> Self` — cycles to next tab (wraps around from last to first)
      - `fn previous(self) -> Self` — cycles to previous tab (wraps around from first to last)

   b. `App` struct with fields:
      - `selected_tab: SelectedTab`
      - `should_quit: bool`
      - `repo: Repository` (git2::Repository — stored to be used in later phases)

   c. `App::new(repo: Repository) -> Self` — constructor with defaults

   d. `App::run(&mut self, terminal: &mut Terminal<impl Backend>) -> color_eyre::Result<()>` — main event loop:
      - Loop: draw frame, then poll for events
      - Use `crossterm::event::poll(Duration::from_millis(100))` for responsive but low-CPU polling
      - On `Event::Key(key)` where `key.kind == KeyEventKind::Press` (Windows compatibility per research):
        - `KeyCode::Char('q')` or `KeyCode::Char('Q')` → set `should_quit = true`
        - `KeyCode::Tab` → call `self.selected_tab = self.selected_tab.next()`
        - `KeyCode::BackTab` (Shift+Tab) → call `self.selected_tab = self.selected_tab.previous()`
      - Break loop when `should_quit` is true

   e. `App::draw(&self, frame: &mut Frame)` — render method called inside `terminal.draw()`:
      - Create a vertical layout with two chunks: top area for tab bar (3 lines high using Constraint::Length(3)), bottom area for tab content (Constraint::Min(0))
      - Render tab bar in top chunk using `ratatui::widgets::Tabs::new()` with tab titles from `SelectedTab` enum iterator (use strum EnumIter). Set `.select(self.selected_tab as usize)`. Style the highlight with yellow foreground and bold. Wrap in a Block with borders and title "stash-mgr".
      - Render tab content in bottom chunk: match on `self.selected_tab`:
        - `SelectedTab::Create` → render a `Paragraph` with text "Create Stash tab — file selection coming in Phase 3" centered in the area, with a Block border titled "Create Stash"
        - `SelectedTab::Manage` → render a `Paragraph` with text "Manage Stashes tab — stash browser coming in Phase 2" centered in the area, with a Block border titled "Manage Stashes"
      - Add a bottom help line (either in the tab content block or as a third layout row): "q: Quit | Tab: Switch Tab"

2. Update src/main.rs to import and use the App module properly. Ensure `mod app; mod tui;` declarations are present.
  </action>
  <verify>
Run `cargo build` — compiles without warnings (use `cargo build 2>&1`). Run `cargo run` from a git repo:
- App shows tab bar with "Create Stash" and "Manage Stashes" tabs
- "Create Stash" tab is selected by default (highlighted)
- Pressing Tab switches to "Manage Stashes" tab (highlight moves, content area changes)
- Pressing Tab again switches back to "Create Stash"
- Pressing Shift+Tab goes in reverse direction
- Pressing 'q' exits cleanly and terminal is restored
- Test panic recovery: temporarily add `panic!("test")` after app creation in main.rs, run, verify terminal is restored after panic message prints. Remove the test panic after verifying.
  </verify>
  <done>
Application launches with two-tab TUI. Tab key cycles between Create Stash and Manage Stashes. Each tab shows placeholder content. q quits cleanly. BackTab navigates in reverse. Terminal state is fully restored on both normal exit and panic.
  </done>
</task>

</tasks>

<verification>
Phase 1 verification checklist:

1. FNDN-01 (Git repo detection): `cargo run` from repo subdirectory works; `cargo run` from non-repo prints error
2. FNDN-02 (Terminal lifecycle): Alternate screen entered on launch, restored on exit. Raw mode enabled during app, disabled after. Panic hook restores terminal.
3. FNDN-03 (Tab navigation): Tab key switches between Create Stash and Manage Stashes. BackTab reverses direction. Active tab is visually highlighted.
4. FNDN-04 (Quit): 'q' key exits the application cleanly.

Run: `cargo test` (should pass, even if no tests yet — no compile errors)
Run: `cargo clippy` (no warnings)
</verification>

<success_criteria>
- `cargo build` succeeds with zero errors
- `cargo clippy` produces no warnings
- Binary launches TUI with visible tab bar showing "Create Stash" (selected) and "Manage Stashes"
- Tab key switches active tab, content area updates
- 'q' exits cleanly with terminal restored
- Running outside a git repo shows helpful error without entering TUI
- Forced panic restores terminal state
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
