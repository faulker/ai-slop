---
phase: 03-stash-creator
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/app.rs]
autonomous: true

must_haves:
  truths:
    - "User sees a list of modified and staged tracked files (no untracked) in the Create Stash tab"
    - "User can navigate the file list with Up/Down arrow keys and j/k vim keys"
    - "User can toggle file selection with space key and see checkbox state change"
    - "When no modified files exist, user sees an informative empty state message"
  artifacts:
    - path: "src/app.rs"
      provides: "FileEntry struct, FileListState, working directory status loading, checkbox list rendering"
      contains: "FileEntry"
  key_links:
    - from: "src/app.rs"
      to: "git2::Repository"
      via: "statuses() with StatusOptions for tracked-only filtering"
      pattern: "StatusOptions|include_untracked"
    - from: "src/app.rs"
      to: "ratatui::widgets::List"
      via: "StatefulWidget render with ListState for file selection"
      pattern: "file_list_state|FileListState"
---

<objective>
Implement the file list display with navigation and checkbox selection for the Create Stash tab.

Purpose: Users can see their working directory changes and select which files to stash.
Output: Create Stash tab shows a navigable file list with checkbox toggles for selection.
</objective>

<execution_context>
@/Users/sane/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sane/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-stash-creator/03-RESEARCH.md
@.planning/phases/02-stash-browser/02-02-SUMMARY.md
@src/app.rs
@src/main.rs
@src/tui.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: File entry data model, working directory status loading, and selection state</name>
  <files>src/app.rs</files>
  <action>
Add the data model and git status loading for the Create Stash tab:

1. **FileEntry struct**: Create a struct with fields:
   - `path: String` - the file path relative to repo root
   - `status: git2::Status` - the git status flags for this file
   - `selected: bool` - whether the user has selected this file for stashing (default: false)
   Derive Clone and Debug.

2. **FileListState struct**: Create a struct to manage the file list and selection:
   - `list_state: ListState` - ratatui selection state for navigation
   - `files: Vec<FileEntry>` - the files with their selection states

   Add methods:
   - `new(files: Vec<FileEntry>) -> Self`: Initialize with files. If files is non-empty, select index 0 via `list_state.select(Some(0))`. Otherwise select None.
   - `toggle_selected(&mut self)`: If a file is currently highlighted (via `list_state.selected()`), flip its `selected` bool.
   - `select_next(&mut self)`: Delegate to `list_state.select_next()`.
   - `select_previous(&mut self)`: Delegate to `list_state.select_previous()`.
   - `selected_files(&self) -> Vec<String>`: Return paths of all files where `selected == true`.
   - `has_selection(&self) -> bool`: Return true if any file has `selected == true`.

3. **load_working_files function**: Add a method `load_working_files(repo: &git2::Repository) -> Vec<FileEntry>` that:
   - Creates `StatusOptions::new()` with `include_untracked(false)` and `include_ignored(false)` -- this is CRITICAL for the "tracked files only" requirement
   - Calls `repo.statuses(Some(&mut opts))`
   - Iterates entries and filters for those whose status intersects: `Status::WT_MODIFIED | Status::WT_DELETED | Status::INDEX_MODIFIED | Status::INDEX_NEW | Status::INDEX_DELETED`
   - Creates a `FileEntry` for each with `selected: false`
   - Returns the Vec. On error, return an empty Vec (don't panic).

4. **format_file_status helper**: Add a function that takes `git2::Status` and returns a display string:
   - `INDEX_NEW` -> "staged new"
   - `INDEX_MODIFIED` -> "staged"
   - `INDEX_DELETED` -> "staged deleted"
   - `WT_MODIFIED` -> "modified"
   - `WT_DELETED` -> "deleted"
   - If status has both INDEX and WT flags, show the INDEX status (staged takes precedence in display)
   - Default fallback: "changed"

5. **App state additions**: Add a field to App:
   - `file_list_state: Option<FileListState>` - None until Create tab is first activated
   Initialize to None in `App::new()`.

6. **File list loading on tab activation**: In `handle_key_event`, when the tab switches to Create (via Tab or BackTab), call a method `refresh_file_list()` that:
   - Calls `load_working_files(&self.repo)`
   - Sets `self.file_list_state = Some(FileListState::new(files))`
   Also call `refresh_file_list()` in `App::new()` so the Create tab has data if the user starts on it (since Create is the default tab).

Add required imports: `use git2::{Status, StatusOptions};`
  </action>
  <verify>
Run `cargo build` and `cargo clippy` -- both must succeed with zero errors and zero warnings. Verify that FileEntry struct exists with path, status, and selected fields. Verify StatusOptions sets include_untracked(false). Verify FileListState has toggle_selected and navigation methods.
  </verify>
  <done>
FileEntry and FileListState structs exist. Working directory files are loaded with tracked-only filtering. Selection state is tracked per file. File list loads on Create tab activation and on startup.
  </done>
</task>

<task type="auto">
  <name>Task 2: Checkbox list rendering with navigation and selection toggle</name>
  <files>src/app.rs</files>
  <action>
Add the UI rendering and keyboard handling for the Create Stash tab file list:

1. **Create tab rendering**: In `render_tab_content` for `SelectedTab::Create`, replace the placeholder paragraph with the file list UI:

   **If file_list_state is None or files is empty:** Show a centered Paragraph: "No modified files -- working directory is clean" with a bordered block titled "Create Stash".

   **If files exist:** Render a full-width List widget:
   - Each `ListItem` shows: `[x] path/to/file (status)` or `[ ] path/to/file (status)`
     - Use `[x]` (with lowercase x) when `file.selected == true`
     - Use `[ ]` when `file.selected == false`
     - The status part uses `format_file_status(file.status)`
   - Block with borders and title "Create Stash - Select Files (Space: toggle, s: stash)"
   - Highlight style: yellow foreground + bold (matches Manage tab pattern)
   - Highlight symbol: "> " (matches Manage tab pattern)
   - Render as stateful widget using `file_list_state.list_state`

2. **Keyboard handling for Create tab**: In `handle_key_event`, add Create tab key handling (conditioned on `self.selected_tab == SelectedTab::Create`):
   - `KeyCode::Down` or `KeyCode::Char('j')`: Call `file_list_state.select_next()` (if file_list_state is Some)
   - `KeyCode::Up` or `KeyCode::Char('k')`: Call `file_list_state.select_previous()` (if file_list_state is Some)
   - `KeyCode::Char(' ')`: Call `file_list_state.toggle_selected()` (if file_list_state is Some)

   IMPORTANT: The Down/Up/j/k keys currently only work when `selected_tab == Manage`. Refactor to also handle these for `Create` tab. One clean approach is to extend the existing match arms to check for either tab, or add new arms for Create. Do NOT break the existing Manage tab behavior.

3. **Help text update**: Update the help text line to be contextual:
   - When on Create tab: "q: Quit | Tab: Switch Tab | Up/Down: Navigate | Space: Toggle | s: Stash Selected"
   - When on Manage tab: keep existing "q: Quit | Tab: Switch Tab | Up/Down: Navigate | a: Apply | p: Pop | d: Drop"
   - When confirm popup visible: keep existing "y: Confirm | n/Esc: Cancel"

4. **Status message for toggle feedback**: When the user toggles a file with space, optionally show a brief status message indicating the selection count, e.g., "2 files selected". Or omit if it feels noisy -- the checkboxes themselves provide the visual feedback. Recommend: do NOT show a status message for toggle (the checkbox is sufficient feedback).
  </action>
  <verify>
Run `cargo build` and `cargo clippy` -- both must succeed with zero errors and zero warnings. Verify that the Create tab renders a list with checkbox symbols. Verify space key toggles selection. Verify arrow keys navigate. Verify help text changes based on active tab.
  </verify>
  <done>
Create Stash tab shows a navigable file list with checkboxes. Space key toggles file selection. Arrow keys and j/k navigate the list. Empty state shows clean working directory message. Help text is contextual per tab.
  </done>
</task>

</tasks>

<verification>
1. `cargo build` succeeds with zero errors
2. `cargo clippy` succeeds with zero warnings
3. Create Stash tab shows list of modified/staged tracked files with status labels
4. No untracked files appear in the list (StatusOptions.include_untracked(false))
5. Arrow keys and j/k navigate the file list with visual highlight
6. Space key toggles the checkbox between [x] and [ ]
7. Empty working directory shows "No modified files" message
8. File list loads when switching to Create tab
9. Existing Manage tab behavior is fully preserved
</verification>

<success_criteria>
- CREA-01: List of modified and staged tracked files displayed (no untracked)
- CREA-02: Arrow keys navigate the file list with highlight
- CREA-03: Space key toggles checkbox selection per file
- Empty state handled with user-friendly message
- Existing Manage tab UI and keybindings unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/03-stash-creator/03-01-SUMMARY.md`
</output>
