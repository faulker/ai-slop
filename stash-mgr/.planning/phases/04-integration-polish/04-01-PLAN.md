---
phase: 04-integration-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/main.rs, src/app.rs]
autonomous: true

must_haves:
  truths:
    - "User sees 'Git index is locked' with remedy when index.lock exists"
    - "User sees 'Not a git repository' when running outside a repo"
    - "User sees 'bare repository' message when in bare repo"
    - "User sees warning when in detached HEAD state"
    - "Stash apply/pop/drop failures show plain English explanations"
    - "Stash creation failure shows user-friendly message"
    - "Repository in merge/rebase state shows 'complete or abort' message"
  artifacts:
    - path: "src/app.rs"
      provides: "friendly_error_message() and validate_repository_state()"
      contains: "fn friendly_error_message"
    - path: "src/main.rs"
      provides: "Improved startup error handling"
      contains: "friendly_error_message"
  key_links:
    - from: "src/app.rs"
      to: "git2::ErrorCode"
      via: "pattern matching in friendly_error_message()"
      pattern: "ErrorCode::Locked"
    - from: "src/app.rs"
      to: "git2::RepositoryState"
      via: "validate_repository_state()"
      pattern: "repo.state()"
    - from: "src/main.rs"
      to: "src/app.rs"
      via: "friendly_error_message for startup errors"
      pattern: "friendly_error_message"
---

<objective>
Add user-friendly error handling throughout the application so users never see raw git2 technical error messages.

Purpose: Phase 4 Success Criterion #1 requires helpful error messages for common failures (no git repo, detached HEAD, locked index). Currently, error paths expose raw git2::Error messages which are technical and confusing.
Output: All git2 error paths converted to plain English with actionable remedies.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-integration-polish/04-RESEARCH.md

@src/main.rs
@src/app.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add friendly error messages and repository validation</name>
  <files>src/app.rs, src/main.rs</files>
  <action>
  In src/app.rs, add a standalone function `friendly_error_message(err: &git2::Error) -> String` that matches on `err.code()` and `err.class()` to produce user-friendly messages. Match these specific cases:
  - ErrorCode::NotFound + ErrorClass::Repository → "Not a git repository (or any parent up to mount point)"
  - ErrorCode::NotFound (other) → "Not found: {err.message()}"
  - ErrorCode::Locked → "Git index is locked. Another git process may be running. Try: rm -f .git/index.lock"
  - ErrorCode::BareRepo → "This is a bare repository. Working directory operations are not supported."
  - ErrorCode::UnbornBranch → "Repository has no commits yet. Create an initial commit first."
  - ErrorCode::Conflict | ErrorCode::MergeConflict → "Cannot perform operation: merge conflicts present. Resolve conflicts first."
  - _ (default) → "Git error: {err.message()}"

  Add `use git2::{ErrorClass, ErrorCode};` to the imports at the top.

  Add a method `validate_repository_state(&self) -> Result<(), String>` to the App impl block that checks:
  1. `self.repo.is_bare()` → return Err with bare repo message
  2. `self.repo.state() != git2::RepositoryState::Clean` → return Err with "Repository is in {state:?} state. Complete or abort that operation first."
  Note: Do NOT block on detached HEAD — stashing works in detached HEAD. Instead, just let it through.

  Call `validate_repository_state()` at the start of `apply_stash()`, `pop_stash()`, `initiate_drop_stash()`, and `create_stash()`. If it returns Err, set `self.status_message = Some(msg)` and return early.

  Replace all raw git2 error messages with friendly_error_message():
  - In `apply_stash()`: change `format!("Apply failed: {}", e)` to `format!("Apply failed: {}", friendly_error_message(&e))`
  - In `pop_stash()`: change `format!("Pop failed: {}", e)` to `format!("Pop failed: {}", friendly_error_message(&e))`
  - In `confirm_drop_stash()`: change `format!("Drop failed: {}", e)` to `format!("Drop failed: {}", friendly_error_message(&e))`
  - In `create_stash()`: change `format!("Stash creation failed: {}", e)` to `format!("Stash creation failed: {}", friendly_error_message(&e))`
  - In `get_stash_diff()`: change `format!("Failed to generate diff: {}", e)` to `format!("Failed to generate diff: {}", friendly_error_message(&e))`

  In src/main.rs:
  - Change the Repository::discover error handler to use the friendly_error_message function from app module. Update the import to `use crate::app::friendly_error_message;` (make the function `pub` in app.rs).
  - Replace the hardcoded error message with: `eprintln!("Error: {}", app::friendly_error_message(&e));`
  - After successfully opening the repo, check for detached HEAD: `if repo.head_detached().unwrap_or(false) { eprintln!("Warning: Repository is in detached HEAD state. Stash operations will work but without a branch reference."); }`

  Ensure `cargo build` and `cargo clippy` pass with zero warnings.
  </action>
  <verify>
  Run `cargo build` — must succeed with 0 errors.
  Run `cargo clippy -- -D warnings` — must pass with 0 warnings.
  Grep for raw git2 error formatting: search for `format!(".*failed.*{}", e)` in app.rs — should find NO occurrences using raw `e` (all should use `friendly_error_message(&e)`).
  </verify>
  <done>
  All git2 error paths in app.rs use friendly_error_message(). Repository state validated before stash operations. Main.rs uses friendly error messages and warns about detached HEAD. No raw git2 error strings exposed to users.
  </done>
</task>

</tasks>

<verification>
1. `cargo build` succeeds
2. `cargo clippy -- -D warnings` passes
3. No raw `format!("...{}", e)` patterns remain for git2 errors in app.rs
4. `friendly_error_message` is `pub` and used in both main.rs and app.rs
5. `validate_repository_state` is called in apply_stash, pop_stash, initiate_drop_stash, create_stash
</verification>

<success_criteria>
All git2 error messages are converted to user-friendly plain English. Repository state is validated before destructive operations. Detached HEAD produces a warning at startup rather than confusing errors later.
</success_criteria>

<output>
After completion, create `.planning/phases/04-integration-polish/04-01-SUMMARY.md`
</output>
