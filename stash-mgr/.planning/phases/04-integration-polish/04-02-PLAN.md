---
phase: 04-integration-polish
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified: [src/app.rs]
autonomous: true

must_haves:
  truths:
    - "Large diffs (>10,000 lines) are truncated with a clear message instead of freezing the UI"
    - "Repositories with >1,000 modified files show a capped list with count of hidden files"
    - "User can complete full workflow: select files, create stash, switch tabs, browse, apply/pop/drop"
    - "cargo build succeeds with 0 errors"
    - "cargo clippy passes with 0 warnings"
  artifacts:
    - path: "src/app.rs"
      provides: "MAX_DIFF_LINES and MAX_FILES_TO_DISPLAY constants with truncation logic"
      contains: "MAX_DIFF_LINES"
  key_links:
    - from: "src/app.rs"
      to: "git2::Diff::print"
      via: "line counter with early return false"
      pattern: "line_count >= MAX_DIFF_LINES"
    - from: "src/app.rs"
      to: "StatusOptions"
      via: "file count cap in load_working_files"
      pattern: "MAX_FILES_TO_DISPLAY"
---

<objective>
Add performance safeguards for large diffs and file lists, then verify the complete end-to-end workflow compiles and passes static analysis.

Purpose: Phase 4 Success Criterion #4 requires large diffs and repositories don't cause memory issues or UI freezes. Currently, try_get_stash_diff loads unlimited lines and load_working_files has no cap.
Output: Bounded diff loading, bounded file list, and a clean build.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-integration-polish/04-RESEARCH.md
@.planning/phases/04-integration-polish/04-01-SUMMARY.md

@src/app.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add diff line limit and file list cap</name>
  <files>src/app.rs</files>
  <action>
  Add two constants at the top of app.rs (after the imports, before the struct definitions):
  ```rust
  /// Maximum number of diff lines to display before truncation.
  /// Prevents UI freezes on very large diffs. Well below ratatui's u16::MAX buffer limit.
  const MAX_DIFF_LINES: usize = 10_000;

  /// Maximum number of files to display in the Create Stash file list.
  /// Prevents UI freezes in repositories with extremely large working trees.
  const MAX_FILES_TO_DISPLAY: usize = 1_000;
  ```

  Modify `try_get_stash_diff()` to accept a `max_lines: usize` parameter and enforce the limit:
  - Add a `line_count` variable initialized to 0 before the `diff.print()` call
  - Inside the print callback, BEFORE processing the line, check: `if line_count >= max_lines { return false; }` — this stops iteration
  - After processing each line's content, increment line_count by the number of newlines in the content (use `content.lines().count().max(1)`)
  - After the `diff.print()` call completes, if `line_count >= max_lines`, append `"\n... (diff truncated — showing first {} lines) ..."` formatted with max_lines to diff_text

  Update `get_stash_diff()` to pass `MAX_DIFF_LINES` to `try_get_stash_diff()`.

  Modify `load_working_files()` to enforce the file cap:
  - After the `for entry in statuses.iter()` loop body (inside the loop), add a check: if `files.len() >= MAX_FILES_TO_DISPLAY`, push a sentinel FileEntry with path `format!("... ({} more files not shown)", statuses.len() - files.len())`, status `Status::empty()`, selected `false`, then break.
  - This sentinel entry appears at the end of the list as a visual indicator.

  Ensure `cargo build` and `cargo clippy` pass with zero warnings.
  </action>
  <verify>
  Run `cargo build` — must succeed with 0 errors.
  Run `cargo clippy -- -D warnings` — must pass with 0 warnings.
  Grep for `MAX_DIFF_LINES` in app.rs — must exist.
  Grep for `MAX_FILES_TO_DISPLAY` in app.rs — must exist.
  Verify `try_get_stash_diff` signature includes `max_lines` parameter.
  </verify>
  <done>
  Diff loading is bounded at 10,000 lines with a clear truncation message. File list is bounded at 1,000 entries with a count of hidden files. Both safeguards prevent UI freezes on large repositories.
  </done>
</task>

<task type="auto">
  <name>Task 2: End-to-end build verification</name>
  <files>src/main.rs, src/app.rs, src/tui.rs</files>
  <action>
  Run the full verification suite to confirm the application is production-ready:
  1. `cargo build --release` — verify release build succeeds
  2. `cargo clippy -- -D warnings` — verify zero warnings in strict mode
  3. `cargo test` — verify test suite passes (currently 0 tests, but compilation must succeed)
  4. Verify all Phase 4 success criteria are met at the code level:
     - SC1: Search for `friendly_error_message` — must exist and be used in error paths
     - SC2: Search for `KeyEventKind::Press` — must exist for cross-platform key filtering
     - SC3: Search for key handlers for all workflow actions (Tab, Space, s, a, p, d) — must exist
     - SC4: Search for `MAX_DIFF_LINES` — must exist for performance safeguard

  If any verification fails, fix the issue before marking complete.
  </action>
  <verify>
  `cargo build --release` succeeds.
  `cargo clippy -- -D warnings` passes.
  `cargo test` passes.
  All four Phase 4 success criteria have corresponding code.
  </verify>
  <done>
  Application builds cleanly in release mode, passes all static analysis, and has code-level support for all Phase 4 success criteria: user-friendly errors, cross-platform key handling, complete workflow support, and large diff performance safeguards.
  </done>
</task>

</tasks>

<verification>
1. `cargo build --release` succeeds
2. `cargo clippy -- -D warnings` passes with 0 warnings
3. `cargo test` passes
4. MAX_DIFF_LINES constant exists and is used in try_get_stash_diff
5. MAX_FILES_TO_DISPLAY constant exists and is used in load_working_files
6. Diff truncation message appears when line limit is exceeded
7. File list shows "... (N more files not shown)" when cap is reached
</verification>

<success_criteria>
Large diffs are truncated at 10,000 lines with user-visible message. Large file lists are capped at 1,000 entries with overflow indicator. Release build succeeds. All static analysis passes. The complete user workflow (create stash, browse, apply/pop/drop) is functional without errors.
</success_criteria>

<output>
After completion, create `.planning/phases/04-integration-polish/04-02-SUMMARY.md`
</output>
