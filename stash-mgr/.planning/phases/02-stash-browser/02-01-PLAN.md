---
phase: 02-stash-browser
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/app.rs]
autonomous: true

must_haves:
  truths:
    - "User sees a list of all stashes with index, message, and branch name in the Manage Stashes tab"
    - "User can navigate the stash list with Up/Down arrow keys and see the selection highlight move"
    - "User sees a diff preview of the selected stash in a side panel that updates when selection changes"
    - "When no stashes exist, user sees an informative empty state message"
  artifacts:
    - path: "src/app.rs"
      provides: "StashEntry struct, stash loading, ListState navigation, split pane layout with diff preview"
      contains: "StashEntry"
  key_links:
    - from: "src/app.rs"
      to: "git2::Repository"
      via: "stash_foreach and diff_tree_to_tree"
      pattern: "stash_foreach|diff_tree_to_tree"
    - from: "src/app.rs"
      to: "ratatui::widgets::List"
      via: "StatefulWidget render with ListState"
      pattern: "StatefulWidget::render|ListState"
---

<objective>
Implement the read-only stash browser: stash list display with navigation and diff preview panel.

Purpose: Users can see their stashes and preview what each contains before deciding to apply or delete.
Output: Manage Stashes tab shows a navigable stash list (left) with a live diff preview (right).
</objective>

<execution_context>
@/Users/sane/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sane/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-stash-browser/02-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@src/app.rs
@src/main.rs
@src/tui.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Stash data model, git loading, and navigable list rendering</name>
  <files>src/app.rs</files>
  <action>
Add stash browsing state and rendering to the existing App in src/app.rs:

1. **StashEntry struct**: Create a struct with fields: `index: usize`, `message: String`, `branch: String`, `oid: git2::Oid`. Parse the branch name from the stash message (format is typically "WIP on branch: hash message" or "On branch: message"). Extract the branch name between "on " and ":". If parsing fails, use "unknown" as branch.

2. **Stash loading function**: Add a method `load_stashes(repo: &git2::Repository) -> Vec<StashEntry>` that uses `repo.stash_foreach()` to collect all stashes. The callback receives `(index, name, oid)`. Parse `name` to extract the user's message and branch name. Return a Vec sorted by index (stash_foreach already iterates in index order).

3. **App state additions**: Add these fields to App:
   - `stashes: Vec<StashEntry>` - loaded stash entries
   - `stash_list_state: ratatui::widgets::ListState` - selection state for the list
   Load stashes in `App::new()` by calling `load_stashes`.

4. **List rendering**: In `render_tab_content` for the `Manage` tab, replace the placeholder with a `List` widget. Each `ListItem` should show: `stash@{index}: message (branch)`. Use `StatefulWidget::render` (not `Widget::render`) to connect the list to `stash_list_state`. Apply highlight style: yellow foreground + bold. Use "> " as highlight symbol.

5. **Arrow key navigation**: In `handle_key_event`, when `selected_tab == Manage`:
   - `KeyCode::Down` or `KeyCode::Char('j')`: call `self.stash_list_state.select_next()`
   - `KeyCode::Up` or `KeyCode::Char('k')`: call `self.stash_list_state.select_previous()`
   On initial load with stashes, select index 0 via `stash_list_state.select(Some(0))`.

6. **Empty state**: When stashes is empty, render a centered Paragraph: "No stashes found. Use 'git stash' or the Create Stash tab to create one."

Add required imports: `use ratatui::widgets::{List, ListItem, ListState, StatefulWidget};`

Do NOT add the diff preview yet -- that is Task 2.
  </action>
  <verify>
Run `cargo build` and `cargo clippy` -- both must succeed with zero errors and zero warnings. Verify that the StashEntry struct exists and load_stashes function compiles. Verify ListState is used for selection tracking.
  </verify>
  <done>
Manage Stashes tab shows stash list with index, message, and branch. Up/Down arrow keys navigate the list with visual highlight. Empty state shows informative message when no stashes exist.
  </done>
</task>

<task type="auto">
  <name>Task 2: Split pane layout with scrollable diff preview</name>
  <files>src/app.rs</files>
  <action>
Add the diff preview panel to the Manage Stashes tab:

1. **Diff generation function**: Add a method `get_stash_diff(repo: &git2::Repository, stash_oid: git2::Oid) -> String` that:
   - Finds the stash commit via `repo.find_commit(stash_oid)`
   - Gets the stash commit's tree via `commit.tree()`
   - Gets the parent tree via `commit.parent(0)?.tree()`
   - Creates a diff via `repo.diff_tree_to_tree(Some(&parent_tree), Some(&stash_tree), None)`
   - Formats using `diff.print(DiffFormat::Patch, callback)` collecting lines into a String
   - On error, returns a descriptive error string (e.g., "Failed to generate diff: {err}")
   - Add the origin character ('+', '-', ' ', etc.) from `line.origin()` before each line's content for proper unified diff display. Skip the origin char for file header lines (origin 'H' or 'F' etc. -- specifically only prepend for context ' ', addition '+', deletion '-', and binary 'B' origins).

2. **App state for diff preview**: Add fields:
   - `diff_content: String` - current diff text
   - `diff_scroll: u16` - vertical scroll offset for diff preview
   Initialize both to empty/zero.

3. **Diff update on selection change**: Whenever the stash selection changes (Up/Down key press, initial load), update `diff_content` by calling `get_stash_diff` with the selected stash's OID. Reset `diff_scroll` to 0 on selection change.

4. **Split pane layout**: In the Manage tab rendering, split the content area horizontally:
   - Left panel (40%): stash list (already built in Task 1)
   - Right panel (60%): diff preview
   Use `Layout::default().direction(Direction::Horizontal).constraints(vec![Constraint::Percentage(40), Constraint::Percentage(60)])`.

5. **Diff preview rendering**: Render the diff as a `Paragraph` widget with:
   - Block with border and title "Diff Preview"
   - `.scroll((self.diff_scroll, 0))` for vertical scrolling
   - Syntax highlighting for diff lines: lines starting with '+' in green, '-' in red, '@@' in cyan. Use `ratatui::text::Line` with styled `Span`s to colorize.

6. **Diff scroll keybindings**: When on the Manage tab:
   - `KeyCode::Right` or `KeyCode::Char('l')`: scroll diff down by 1
   - `KeyCode::Left` or `KeyCode::Char('h')`: scroll diff up by 1
   - `Ctrl+d`: scroll diff down by half a page (10 lines)
   - `Ctrl+u`: scroll diff up by half a page (10 lines)
   Use `saturating_add` and `saturating_sub` to prevent overflow/underflow.

7. **Help text update**: Update the help line at the bottom to show contextual keybindings: "q: Quit | Tab: Switch Tab | Up/Down: Navigate | Left/Right: Scroll Diff"

Add required imports: `use ratatui::layout::Direction;`, `use ratatui::text::Span;`, `use git2::DiffFormat;`
  </action>
  <verify>
Run `cargo build` and `cargo clippy` -- both must succeed with zero errors and zero warnings. Verify the layout splits horizontally. Verify diff content is generated from git2 tree comparison. Verify scroll keybindings are handled.
  </verify>
  <done>
Manage Stashes tab shows split pane: stash list on left (40%), diff preview on right (60%). Selecting a stash updates the diff preview. Diff lines are colorized (green for additions, red for deletions, cyan for hunk headers). User can scroll the diff with arrow keys and Ctrl+d/u.
  </done>
</task>

</tasks>

<verification>
1. `cargo build` succeeds with zero errors
2. `cargo clippy` succeeds with zero warnings
3. `cargo test` compiles successfully
4. Manage Stashes tab renders a stash list with proper formatting (index, message, branch)
5. Arrow keys navigate the stash list with visual highlight
6. Selecting a stash shows its diff in the right panel with syntax coloring
7. Empty stash list shows an informative message
8. Diff preview scrolls with keybindings
</verification>

<success_criteria>
- BRWS-01: Stash list displays index, message, and branch name for each stash
- BRWS-02: Up/Down arrow keys navigate stash list with highlight
- BRWS-03: Right panel shows diff preview that updates on selection change
- Empty state handled gracefully with user-friendly message
- All diff lines colorized: + green, - red, @@ cyan
</success_criteria>

<output>
After completion, create `.planning/phases/02-stash-browser/02-01-SUMMARY.md`
</output>
