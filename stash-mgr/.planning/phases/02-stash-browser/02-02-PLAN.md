---
phase: 02-stash-browser
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified: [src/app.rs]
autonomous: true

must_haves:
  truths:
    - "User can apply a stash with 'a' key and the stash remains in the list"
    - "User can pop a stash with 'p' key and the stash is removed from the list"
    - "User can press 'd' to initiate drop, sees a confirmation popup, and must press 'y' to confirm deletion"
    - "After any stash operation, the stash list refreshes and selection adjusts correctly"
    - "If a stash operation fails (e.g., conflict), user sees an error message instead of a crash"
  artifacts:
    - path: "src/app.rs"
      provides: "Stash apply/pop/drop operations, confirmation popup, error/status display"
      contains: "stash_apply|stash_pop|stash_drop"
  key_links:
    - from: "src/app.rs"
      to: "git2::Repository"
      via: "stash_apply, stash_pop, stash_drop"
      pattern: "stash_apply|stash_pop|stash_drop"
    - from: "src/app.rs"
      to: "ratatui::widgets::Clear"
      via: "Confirmation popup overlay"
      pattern: "Clear"
---

<objective>
Implement stash operations: apply, pop, and drop (with confirmation) for the stash browser.

Purpose: Users can act on their stashes -- applying changes back, removing stashes, or both -- directly from the TUI.
Output: Manage Stashes tab supports apply (a), pop (p), and drop (d with confirmation) keyboard shortcuts.
</objective>

<execution_context>
@/Users/sane/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sane/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-stash-browser/02-RESEARCH.md
@.planning/phases/02-stash-browser/02-01-SUMMARY.md
@src/app.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Apply and pop stash operations with status feedback</name>
  <files>src/app.rs</files>
  <action>
Add apply and pop stash functionality to the App:

1. **Status message state**: Add a field `status_message: Option<String>` to App for displaying operation results. Show this in the help/status area at the bottom of the screen. Clear it on the next keypress (set to None at the start of handle_key_event).

2. **Apply stash (key: 'a')**: When on Manage tab and a stash is selected:
   - Call `repo.stash_apply(index, Some(&mut StashApplyOptions::new()))` where index is the selected stash's index
   - On success: set status_message to `Some("Applied stash@{index} successfully".to_string())`
   - On error: set status_message to `Some(format!("Apply failed: {}", err))`
   - Do NOT remove from list (apply keeps the stash)
   - Do NOT refresh the stash list (stash remains unchanged)
   - If no stash is selected (None), do nothing

3. **Pop stash (key: 'p')**: When on Manage tab and a stash is selected:
   - Call `repo.stash_pop(index, Some(&mut StashApplyOptions::new()))` where index is the selected stash's index
   - On success:
     - Set status_message to `Some("Popped stash@{index} successfully".to_string())`
     - Reload stash list (call load_stashes again)
     - Adjust selection: if the popped stash was the last one, select the new last item. If list is now empty, select None. Otherwise keep the same index (next stash slides into this position).
     - Update diff_content for the newly selected stash (or clear if empty)
   - On error: set status_message to `Some(format!("Pop failed: {}", err))`

4. **Repo mutability**: The `repo` field in App needs to be used mutably for pop (stash_pop requires `&mut Repository`). Since apply also may need `&mut`, ensure the repo field is accessible as `&mut self.repo`. This should work since `handle_key_event` takes `&mut self`.

   IMPORTANT: `stash_apply` takes `&self` (immutable) on Repository, but `stash_pop` takes `&mut self`. To avoid borrow checker issues, do NOT hold any borrows of `self` when calling repo methods. Specifically:
   - Extract the stash index from `self.stash_list_state.selected()` into a local variable first
   - Then call the repo method
   - Then update status_message

5. **Status rendering**: Replace the simple help text line at the bottom with a two-part display:
   - If status_message is Some: show the status message (green for success, red for failure -- detect by checking if message contains "failed")
   - Below or beside it: show the help text keybindings
   - Update help text to include: "a: Apply | p: Pop | d: Drop | q: Quit | Tab: Switch Tab"

Add required imports: `use git2::StashApplyOptions;`
  </action>
  <verify>
Run `cargo build` and `cargo clippy` -- both must succeed with zero errors and zero warnings. Verify stash_apply and stash_pop are called with correct index. Verify status message is rendered.
  </verify>
  <done>
User can press 'a' to apply selected stash (stays in list) with success/error feedback. User can press 'p' to pop selected stash (removed from list, list refreshes). Status messages display at bottom in green (success) or red (failure).
  </done>
</task>

<task type="auto">
  <name>Task 2: Drop stash with confirmation popup</name>
  <files>src/app.rs</files>
  <action>
Add drop stash with a confirmation dialog overlay:

1. **Confirmation popup state**: Add fields to App:
   - `show_confirm_popup: bool` - whether the popup is visible
   - `confirm_stash_index: Option<usize>` - which stash index is pending deletion
   Initialize both to false/None.

2. **Drop initiation (key: 'd')**: When on Manage tab and a stash is selected and popup is NOT visible:
   - Set `show_confirm_popup = true`
   - Set `confirm_stash_index = Some(selected_index)`
   - Do NOT perform the drop yet

3. **Popup key handling**: When `show_confirm_popup` is true, intercept ALL key events before normal handling:
   - 'y' or 'Y': Confirm the drop
     - Call `repo.stash_drop(confirm_stash_index.unwrap())` (stash_drop takes `&mut self`)
     - On success: status_message = "Dropped stash@{index} successfully"
     - On error: status_message = format!("Drop failed: {}", err)
     - Reload stash list
     - Adjust selection (same logic as pop: clamp to list bounds)
     - Update diff_content
     - Reset popup state: show_confirm_popup = false, confirm_stash_index = None
   - 'n' or 'N' or Escape: Cancel
     - Reset popup state: show_confirm_popup = false, confirm_stash_index = None
   - Any other key: ignore (popup stays visible)
   - CRITICAL: Return early from handle_key_event when popup is visible to prevent other actions (like 'q' to quit) from firing during confirmation

4. **Popup rendering**: Add a render function that draws the confirmation popup overlay:
   - Calculate a centered popup area: 60% width, 20% height using `Layout::vertical` and `Layout::horizontal` with `Flex::Center`
   - Render `Clear` widget over the popup area to erase background
   - Render a `Paragraph` with red border, title "Confirm Drop":
     - Body text: "Drop stash@{index}: {message}?\n\nThis cannot be undone.\n\nPress 'y' to confirm, 'n' or Esc to cancel"
     - Center the text with `.centered()`
   - Call this render function AFTER rendering the main content in `draw()` so it overlays on top

5. **Help text update**: When popup is visible, the help text should show "y: Confirm | n/Esc: Cancel" instead of the normal keybindings.

Add required imports: `use ratatui::widgets::Clear;`, `use ratatui::layout::Flex;`
  </action>
  <verify>
Run `cargo build` and `cargo clippy` -- both must succeed with zero errors and zero warnings. Verify popup state management (show/hide). Verify stash_drop is called only after confirmation. Verify popup rendering uses Clear widget.
  </verify>
  <done>
User presses 'd' and sees a confirmation popup with stash details. Pressing 'y' drops the stash and refreshes the list. Pressing 'n' or Esc cancels without action. No other keys work while popup is visible. Popup renders as an overlay with red border.
  </done>
</task>

</tasks>

<verification>
1. `cargo build` succeeds with zero errors
2. `cargo clippy` succeeds with zero warnings
3. `cargo test` compiles successfully
4. 'a' key applies selected stash without removing it from list
5. 'p' key pops selected stash, removes it, and refreshes list with adjusted selection
6. 'd' key shows confirmation popup; 'y' drops, 'n'/Esc cancels
7. Status messages appear at bottom for all operations (success and failure)
8. Stash list refreshes correctly after pop and drop (indices re-numbered)
9. Selection adjusts when last stash is removed
10. No keys except y/n/Esc work during confirmation popup
</verification>

<success_criteria>
- BRWS-04: Apply stash with 'a' key, stash stays in list, success feedback shown
- BRWS-05: Pop stash with 'p' key, stash removed from list, list refreshes
- BRWS-06: Drop stash requires 'd' then 'y' confirmation, prevents accidental deletion
- Error messages displayed for failed operations (conflicts, etc.)
- Stash indices correctly re-numbered after removal operations
</success_criteria>

<output>
After completion, create `.planning/phases/02-stash-browser/02-02-SUMMARY.md`
</output>
